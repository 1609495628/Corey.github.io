<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>深入理解Java虚拟机读书笔记（一） | Corey Blog</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/img/favicon.ico">
    <script data-ad-client="ca-pub-7828333725993554" async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="我的个人博客">
    <meta name="keywords" content="后端博客,个人技术博客,后端,后端开发,后端框架,web后端,后端面试题,技术文档,学习,面试,源码，感悟，Java,Pythn,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.179c1acd.css" as="style"><link rel="preload" href="/assets/js/app.88395ae1.js" as="script"><link rel="preload" href="/assets/js/2.ea0e9185.js" as="script"><link rel="preload" href="/assets/js/3.674b93db.js" as="script"><link rel="preload" href="/assets/js/14.e4f36641.js" as="script"><link rel="prefetch" href="/assets/js/10.0ad18d18.js"><link rel="prefetch" href="/assets/js/11.5b4e742c.js"><link rel="prefetch" href="/assets/js/12.4b6cc795.js"><link rel="prefetch" href="/assets/js/13.433f7a5d.js"><link rel="prefetch" href="/assets/js/15.f5a95113.js"><link rel="prefetch" href="/assets/js/16.4ef02f07.js"><link rel="prefetch" href="/assets/js/17.3b8f16c7.js"><link rel="prefetch" href="/assets/js/18.00b7a69d.js"><link rel="prefetch" href="/assets/js/19.f22f2ed5.js"><link rel="prefetch" href="/assets/js/20.7ade9b57.js"><link rel="prefetch" href="/assets/js/21.fc8e3b4e.js"><link rel="prefetch" href="/assets/js/22.72d7b55f.js"><link rel="prefetch" href="/assets/js/23.e73fb787.js"><link rel="prefetch" href="/assets/js/24.a24fc598.js"><link rel="prefetch" href="/assets/js/25.3a5636f7.js"><link rel="prefetch" href="/assets/js/4.64883d43.js"><link rel="prefetch" href="/assets/js/5.13e3213a.js"><link rel="prefetch" href="/assets/js/6.7bac4897.js"><link rel="prefetch" href="/assets/js/7.35ad56ae.js"><link rel="prefetch" href="/assets/js/8.9a9f866d.js"><link rel="prefetch" href="/assets/js/9.a96a40c0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.179c1acd.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Corey Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分类</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div> <a href="https://github.com/wu-Corey/wu-Corey.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="img/me.jpg"> <div class="blogger-info"><h3>Corey</h3> <span>Seven times have I despised my soul</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分类</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div> <a href="https://github.com/wu-Corey/wu-Corey.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>JavaSE</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>JUC</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>集合</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>JVM</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/049435/" aria-current="page" class="active sidebar-link">深入理解Java虚拟机读书笔记（一）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/049435/#_1-java内存区域与内存溢出异常" class="sidebar-link">1.Java内存区域与内存溢出异常</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/049435/#程序计数器" class="sidebar-link">程序计数器</a></li><li class="sidebar-sub-header"><a href="/pages/049435/#java虚拟机栈" class="sidebar-link">Java虚拟机栈</a></li><li class="sidebar-sub-header"><a href="/pages/049435/#本地方法栈" class="sidebar-link">本地方法栈</a></li><li class="sidebar-sub-header"><a href="/pages/049435/#堆" class="sidebar-link">堆</a></li><li class="sidebar-sub-header"><a href="/pages/049435/#方法区" class="sidebar-link">方法区</a></li><li class="sidebar-sub-header"><a href="/pages/049435/#直接内存" class="sidebar-link">直接内存</a></li><li class="sidebar-sub-header"><a href="/pages/049435/#对象访问" class="sidebar-link">对象访问</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/049435/#_2-垃圾收集器与内存分配策略" class="sidebar-link">2.垃圾收集器与内存分配策略</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/049435/#如何确定对象已死-需要回收" class="sidebar-link">如何确定对象已死，需要回收？</a></li><li class="sidebar-sub-header"><a href="/pages/049435/#垃圾收集算法" class="sidebar-link">垃圾收集算法</a></li><li class="sidebar-sub-header"><a href="/pages/049435/#垃圾收集器" class="sidebar-link">垃圾收集器</a></li><li class="sidebar-sub-header"><a href="/pages/049435/#内存分配与回收策略" class="sidebar-link">内存分配与回收策略</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/049435/#_3-虚拟机性能监控与故障处理工具" class="sidebar-link">3.虚拟机性能监控与故障处理工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/049435/#命令行工具" class="sidebar-link">命令行工具</a></li><li class="sidebar-sub-header"><a href="/pages/049435/#可视化工具" class="sidebar-link">可视化工具</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/049435/#_4-调优案例分析与实战" class="sidebar-link">4.调优案例分析与实战</a></li><li class="sidebar-sub-header"><a href="/pages/049435/#_4-调优案例分析与实战-2" class="sidebar-link">4.调优案例分析与实战</a></li></ul></li><li><a href="/pages/d9969a/" class="sidebar-link">深入理解Java虚拟机读书笔记（二）</a></li><li><a href="/pages/5cd412/" class="sidebar-link">深入理解Java虚拟机（三）</a></li><li><a href="/pages/f6d9e1/" class="sidebar-link">深入理解Java虚拟机读书笔记（四）</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MySQL</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中间件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机科学</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-071ed482><div class="articleInfo" data-v-071ed482><ul class="breadcrumbs" data-v-071ed482><li data-v-071ed482><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-071ed482></a></li> <li data-v-071ed482><a href="/categories/?category=%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0" title="分类" data-v-071ed482>技术文章</a></li> <li data-v-071ed482><a href="/categories/?category=Java" title="分类" data-v-071ed482>Java</a></li> <li data-v-071ed482><a href="/categories/?category=JVM" title="分类" data-v-071ed482>JVM</a></li></ul> <div class="info" data-v-071ed482><div title="作者" class="author iconfont icon-touxiang" data-v-071ed482><a href="https://github.com/Wu-Corey" target="_blank" title="作者" class="beLink" data-v-071ed482>Corey</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-071ed482><a href="javascript:;" data-v-071ed482>2022-03-06</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">
          深入理解Java虚拟机读书笔记（一）
        </h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="一、走近java"><a href="#一、走近java" class="header-anchor">#</a> 一、走近Java</h1> <h1 id="二、自动内存管理机制"><a href="#二、自动内存管理机制" class="header-anchor">#</a> 二、自动内存管理机制</h1> <h2 id="_1-java内存区域与内存溢出异常"><a href="#_1-java内存区域与内存溢出异常" class="header-anchor">#</a> 1.Java内存区域与内存溢出异常</h2> <h3 id="程序计数器"><a href="#程序计数器" class="header-anchor">#</a> 程序计数器</h3> <ul><li>如果正在执行的方法是Java方法，那么记录的是正在执行的虚拟机字节码指令的地址。但如果执行的本地方法，那么值会为空</li></ul> <h3 id="java虚拟机栈"><a href="#java虚拟机栈" class="header-anchor">#</a> Java虚拟机栈</h3> <ul><li><p>存局部变量表、操作栈、动态链接、方法出口</p></li> <li><ul><li>局部变量表</li></ul></li> <li><ul><li><ul><li>编译期可知的基本数据类型(long、double占2个局部变量空间，其他占1个)</li> <li>对象引用</li></ul></li></ul></li> <li><ul><li><ul><li>returnAddress</li> <li>局部变量表需要的内存空间，在编译期完成分配</li></ul></li></ul></li></ul> <h3 id="本地方法栈"><a href="#本地方法栈" class="header-anchor">#</a> 本地方法栈</h3> <h3 id="堆"><a href="#堆" class="header-anchor">#</a> 堆</h3> <p>几乎所有对象、数组都在堆上分配（不一定所有）</p> <ul><li>划分：新生代、老年代</li> <li>从内存分配角度划分：可划分出多个线程私有的分配缓冲区（Thread Local Allocation Buffer,TLAB）</li></ul> <h3 id="方法区"><a href="#方法区" class="header-anchor">#</a> 方法区</h3> <p>存虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码</p> <ul><li><p>运行时常量池：</p></li> <li><ul><li>class文件中有常量池，放了编译期产生的字面量、符号引用。这些在类加载后，会放入运行时常量池</li> <li>相比于class文件中的常量池，具备动态性。即不要求一定要先预置入class文件常量池，再进运行时常量池。运行期间也可能放进新的常量到池里。应用：比如String.intern()</li></ul></li></ul> <h3 id="直接内存"><a href="#直接内存" class="header-anchor">#</a> 直接内存</h3> <ul><li><p>并不属于虚拟机运行时数据区。</p></li> <li><p>NIO类里，可以直接使用native函数直接分配堆外内存，通过Java堆里的DirectByteBuffer对象作为这块内存的引用。这样做可以避免在Java堆和Native堆里来回复制对象，可以提高性能</p></li> <li><p>所以分配内存的时候，不能只考虑Java堆的大小，还要考虑直接内存。否则受物理内存和处理器寻址空间的限制，同样会内存溢出异常</p></li></ul> <h3 id="对象访问"><a href="#对象访问" class="header-anchor">#</a> 对象访问</h3> <p>Object obj = new Object()；其中，Object obj指的是，发生在本地变量表，作为一个reference类型数据，new Object()发生在堆，实例数据。方法区中会存储此对象的类型数据，如对象类型、父类、实现的接口、方法等</p> <p>不同虚拟机有不同的实现，分为句柄访问、指针访问</p> <ul><li><p>句柄访问：</p></li> <li><ul><li>堆中划分出一块内存--句柄池，reference中存储的就是对象的句柄地址。</li> <li>句柄中有指向方法区中类型数据的指针，有指向堆中实例数据的指针</li></ul></li> <li><ul><li>优点是对象移动的时候（垃圾回收时发生很普遍），reference本身不需要修改，只需要改动指针指向的地址</li></ul></li> <li><p>指针访问：</p></li> <li><ul><li>reference存储的就是对象地址</li> <li>优点是速度更快，因为节省了一次指针定位的开销</li></ul></li> <li><ul><li>Sun HotSpot采用</li></ul></li></ul> <h2 id="_2-垃圾收集器与内存分配策略"><a href="#_2-垃圾收集器与内存分配策略" class="header-anchor">#</a> 2.垃圾收集器与内存分配策略</h2> <ul><li><p>关注的目标：</p></li> <li><ul><li>每个栈帧中分配多少内存，在类结构确定时，基本就是确定(不考虑JIT优化)，程序计数器、本地方法栈、虚拟机栈随着方法退出，这些区域的内存分配和回收是确定的，不需过多关心</li> <li>堆和方法区中的内存，只有运行的时候才知道，内存的分配和回收时动态的。因此垃圾收集器关注的是这部分内存</li></ul></li></ul> <h3 id="如何确定对象已死-需要回收"><a href="#如何确定对象已死-需要回收" class="header-anchor">#</a> 如何确定对象已死，需要回收？</h3> <h4 id="引用计数法"><a href="#引用计数法" class="header-anchor">#</a> 引用计数法</h4> <p>给对象一个引用计数器，初始值为1，当有地方引用它，计数器值+1，引用失效，计数器值-1，任何时刻只要计数器的值为0，这个对象就是不可能再被使用的，可以被回收</p> <ul><li><p>缺陷：</p></li> <li><ul><li>无法解决循环引用的问题，即A、B两个对象互相引用，但是没有外部引用指向他们</li></ul></li> <li><p>测试：</p></li></ul> <div class="language-json extra-class"><pre class="language-json"><code>public class TestCounter <span class="token punctuation">{</span>

    static class Student<span class="token punctuation">{</span>
        private Object instance;
				<span class="token comment">// 占用一点内存</span>
        private static final int _1MB = <span class="token number">1024</span> * <span class="token number">1024</span>;
        private static byte<span class="token punctuation">[</span><span class="token punctuation">]</span> b = new byte<span class="token punctuation">[</span><span class="token number">20</span> * _1MB<span class="token punctuation">]</span>;
    <span class="token punctuation">}</span>

    public static void main(String<span class="token punctuation">[</span><span class="token punctuation">]</span> args) <span class="token punctuation">{</span>
        Student studentA = new Student();
        Student studentB = new Student();
        studentA.instance = studentB;
        studentB.instance = studentA;

        studentA = <span class="token null keyword">null</span>;
        studentB = <span class="token null keyword">null</span>;

        System.gc();
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">[</span>GC (System.gc()) <span class="token punctuation">[</span>PSYoungGen<span class="token operator">:</span> 24289K-&gt;872K(73728K)<span class="token punctuation">]</span> 24289K-&gt;21360K(241664K)<span class="token punctuation">,</span> <span class="token number">0.0182375</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span>Times<span class="token operator">:</span> user=<span class="token number">0.00</span> sys=<span class="token number">0.00</span><span class="token punctuation">,</span> real=<span class="token number">0.02</span> secs<span class="token punctuation">]</span> 
<span class="token punctuation">[</span>Full GC (System.gc()) <span class="token punctuation">[</span>PSYoungGen<span class="token operator">:</span> 872K-&gt;0K(73728K)<span class="token punctuation">]</span> <span class="token punctuation">[</span>ParOldGen<span class="token operator">:</span> 20488K-&gt;21201K(167936K)<span class="token punctuation">]</span> 21360K-&gt;21201K(241664K)<span class="token punctuation">,</span> <span class="token punctuation">[</span>Metaspace<span class="token operator">:</span> 3299K-&gt;3299K(1056768K)<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.0072952</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span>Times<span class="token operator">:</span> user=<span class="token number">0.01</span> sys=<span class="token number">0.00</span><span class="token punctuation">,</span> real=<span class="token number">0.02</span> secs<span class="token punctuation">]</span> 
Heap
 PSYoungGen      total 73728K<span class="token punctuation">,</span> used 635K <span class="token punctuation">[</span>0x000000076e000000<span class="token punctuation">,</span> 0x0000000773200000<span class="token punctuation">,</span> 0x00000007c0000000)
  eden space 63488K<span class="token punctuation">,</span> <span class="token number">1</span>% used <span class="token punctuation">[</span>0x000000076e000000<span class="token punctuation">,</span>0x000000076e09ecf8<span class="token punctuation">,</span>0x0000000771e00000)
  from space 10240K<span class="token punctuation">,</span> <span class="token number">0</span>% used <span class="token punctuation">[</span>0x0000000771e00000<span class="token punctuation">,</span>0x0000000771e00000<span class="token punctuation">,</span>0x0000000772800000)
  to   space 10240K<span class="token punctuation">,</span> <span class="token number">0</span>% used <span class="token punctuation">[</span>0x0000000772800000<span class="token punctuation">,</span>0x0000000772800000<span class="token punctuation">,</span>0x0000000773200000)
 ParOldGen       total 167936K<span class="token punctuation">,</span> used 21201K <span class="token punctuation">[</span>0x00000006ca000000<span class="token punctuation">,</span> 0x00000006d4400000<span class="token punctuation">,</span> 0x000000076e000000)
  object space 167936K<span class="token punctuation">,</span> <span class="token number">12</span>% used <span class="token punctuation">[</span>0x00000006ca000000<span class="token punctuation">,</span>0x00000006cb4b45a0<span class="token punctuation">,</span>0x00000006d4400000)
 Metaspace       used 3306K<span class="token punctuation">,</span> capacity 4500K<span class="token punctuation">,</span> committed 4864K<span class="token punctuation">,</span> reserved 1056768K
  class space    used 360K<span class="token punctuation">,</span> capacity 388K<span class="token punctuation">,</span> committed 512K<span class="token punctuation">,</span> reserved 1048576K
</code></pre></div><p>由此可以看到，循环引用的A、B仍然被GC回收了，所以JVM用的不是引用计数法</p> <h4 id="根搜索算法"><a href="#根搜索算法" class="header-anchor">#</a> 根搜索算法</h4> <p>即可达性分析。从一些GCRoot出发往下搜索，走过的路径称为引用链。当一个对象没有任何引用链相连（图论里称为不可达），则该对象是不可用的。</p> <p>GCRoot：</p> <ul><li><p>虚拟机栈（栈帧中的本地变量表）中引用的对象</p></li> <li><p>方法区中静态属性引用的对象</p></li> <li><p>方法区中常量引用的对象</p></li> <li><p>本地方法栈中本地方法引用的对象</p></li></ul> <h4 id="四种引用"><a href="#四种引用" class="header-anchor">#</a> 四种引用</h4> <ul><li><p>强引用：直接引用</p></li> <li><p>软引用：内存不够不会直接抛错误，而是回收软引用，如果还是不够才抛错误</p></li> <li><p>弱引用：不管内存够不够，下一次gc一定会回收</p></li> <li><p>虚引用：用来回收的时候收到一个通知</p></li></ul> <h4 id="finalize"><a href="#finalize" class="header-anchor">#</a> finalize()</h4> <p>当对象不可达的时候，会进行第一次筛选，并第一标记。判断对象是否有必要执行finalize()方法。如果没必要（1.该对象没有重写finalize()方法或2.方法已执行过一次），直接回收；如果有必要，会进一个F-Queue队列，稍后虚拟机建立一个低优先级的finalizer线程去执行这个方法（虚拟机不会等这个方法执行完成），有一次拯救自己的机会，所以只要有任何一个引用指向它，就会被标记，这样就移出了即将回收的集合。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 2022/2/13
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FinalizeEscapeGc</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">FinalizeEscapeGc</span> SAVE_HOOK <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;finalize method executed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FinalizeEscapeGc</span><span class="token punctuation">.</span>SAVE_HOOK <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        SAVE_HOOK <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalizeEscapeGc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 第一次自救</span>
        <span class="token function">escape</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 再来一次</span>
        <span class="token function">escape</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">escape</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        SAVE_HOOK <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// finalize优先级低 这里先暂停一下</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>SAVE_HOOK <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;yes i am alive&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;no i am dead&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上述代码可以看出，对象执行finalize有一次自救的机会</p> <h3 id="垃圾收集算法"><a href="#垃圾收集算法" class="header-anchor">#</a> 垃圾收集算法</h3> <h4 id="标记-清除"><a href="#标记-清除" class="header-anchor">#</a> 标记-清除</h4> <p>最基础，其他的算法基于标记清除改进</p> <p>缺点：产生较多内存碎片，如果有大对象就无法分配，只能触发一次额外GC</p> <h4 id="复制算法"><a href="#复制算法" class="header-anchor">#</a> 复制算法</h4> <p>把内存划分成两块，保留一块不用，只有其中一块。每次只要这块内存用完了，就把存活的对象复制到另一块，然后一次清除掉用过的内存</p> <p>优点：内存分配不用考虑内存碎片，只要移动堆顶指针，按顺序分配内存。简单高效</p> <p>缺点：可用内存缩小。</p> <p>新生代是采用复制算法</p> <p>Eden : Survivor = 8 ： 1 ： 1</p> <p>每次保留其中一块survivor不用，可用空间为90%。新生代大部分对象朝生夕死</p> <p>分配担保：当survivor没法放下存活的对象时，可以通过分配担保机制进入老年代</p> <h4 id="标记整理"><a href="#标记整理" class="header-anchor">#</a> 标记整理</h4> <p>让所有存活的对象向一端移动，直接清理掉端边界以外的内存</p> <p>适合老年代</p> <h3 id="垃圾收集器"><a href="#垃圾收集器" class="header-anchor">#</a> 垃圾收集器</h3> <p><img src="https://cdn.nlark.com/yuque/0/2022/png/12450544/1644932957328-cd5008e7-943c-4912-b02d-e1f0d621cdc6.png" alt="img"></p> <h4 id="serial收集器"><a href="#serial收集器" class="header-anchor">#</a> Serial收集器</h4> <p>单线程，垃圾收集时会Stop The World，后台停止用户线程，直到收集结束</p> <p>虚拟机运行在client模式下的默认收集器，因为分配的内存不会很大，垃圾收集时间往往只需要几十毫秒，只要不频繁，完全可以接受。</p> <h4 id="parnew收集器"><a href="#parnew收集器" class="header-anchor">#</a> ParNew收集器</h4> <p>Serial收集器的多线程版本，很多特性共用。</p> <p>运行在Server模式下虚拟机的首选收集器，因为除了Serial，只有ParNew新生代收集器，是可以和真正并发的收集器--CMS收集器配合。因为CMS是无法与新生代收集器Parallel Scavenge收集器配合。</p> <p>-XX:+UseConcMarkSweepGC，默认新生代收集器为ParNew</p> <p>-XX:+UseParNewGC，强制使用ParNew收集器</p> <p>ParNew在单CPU环境下可能效果并不比Serial要好，但是在多CPU环境下，GC时对系统资源利用有好处，默认线程数与CPU数相同</p> <p>-XX:ParallelGCThread可以限制垃圾收集的线程数</p> <h4 id="parallel-scavenge收集器"><a href="#parallel-scavenge收集器" class="header-anchor">#</a> Parallel Scavenge收集器</h4> <p>与Serial、ParNew一样是使用复制算法的新生代收集器，多线程。</p> <p>不同之处在于，其他收集器关注尽可能缩短用户线程的停顿时间，而Parallel Scavenge收集器则致力于实现可控制的吞吐量</p> <p>三个参数：</p> <p>-XX:MaxGCPauseMills 垃圾收集最大停顿时间。缩短停顿时间是以牺牲吞吐量、新生代内存空间为代价。系统把新生代调小，那么收集更少的空间，需要停顿的时间也就更短，但这会导致GC更加频繁，可能反而总的GC时间更多，吞吐量降低</p> <p>-XX:GCTimeRatio 直接设置吞吐量。如果设置19，那么GC时间是1/20=5%，吞吐量95%。如果设置99，那么GC时间是1/100=1%，吞吐量99%</p> <p>-XX:+UseAdaptiveSizePolicy 这个参数，可以设置GC自适应调节策略。不需要指定新生代大小、Eden与Survivor比例、晋升老年代对象年龄等细节参数，只需要设置最大最小堆大小，设置一直关注的目标，-XX:MaxGCPauseMills或-XX:GCTimeRatio，让虚拟机动态调整参数提供最合适的停顿时间或吞吐量</p> <h4 id="serial-old收集器"><a href="#serial-old收集器" class="header-anchor">#</a> Serial Old收集器</h4> <p>Serial收集器的老年代版本，使用标记-整理算法，单线程，同样在client模式下虚拟机使用</p> <p>如果在server模式下使用，有两种用途：1.配合Parallel Scavenge 2.作为CMS的后背预案</p> <h4 id="parallel-old收集器"><a href="#parallel-old收集器" class="header-anchor">#</a> Parallel Old收集器</h4> <p>Parallel Scavenge的老年代版本。多线程，标记-整理。</p> <p>主要用途是配合Parallel Scavenge。因为Parallel Scavenge无法与CMS配合，在Parallel Old出现前，只能和Serial Old这种单线程收集器配合使用，服务端性能拖累</p> <h4 id="cms收集器"><a href="#cms收集器" class="header-anchor">#</a> CMS收集器</h4> <ul><li><p>四个阶段：</p></li> <li><ul><li>初始标记：标记GCRoot能直接关联到的对象，速度很快</li> <li>并发标记：GC Roots Tracing</li></ul></li> <li><ul><li>重新标记：修正并发标记期间，由于用户程序运行导致标记变动的那部分对象。停顿时间比初始标记长，但远比并发标记短</li> <li>并发清除：</li></ul></li> <li><p>其中，初始标记、重新标记，仍然需要Stop the World。</p></li> <li><p>最耗时的是并发标记、并发清除</p></li></ul> <p>CMS收集器采用标记清除算法</p> <p>优点：</p> <ul><li>设计目标：最短回收停顿时间</li></ul> <p>缺点：</p> <ul><li><p>CPU资源敏感</p></li> <li><p>无法处理浮动垃圾</p></li> <li><p>产生内存碎片</p></li></ul> <h4 id="g1收集器"><a href="#g1收集器" class="header-anchor">#</a> G1收集器</h4> <ul><li><p>与CMS相比改进点：</p></li> <li><ul><li>基于标记-整理算法，不会产生碎片</li> <li>精确控制停顿。即可以指定在长度为M毫秒的时间段内，GC时间不超过N毫秒</li></ul></li> <li><p>为什么能够实现不牺牲吞吐量，完成低停顿回收？</p></li></ul> <p>避免全区域GC。把整个Java堆，划分为几个独立区域，跟踪垃圾堆积密度，后台维护一个优先列表，每次根据允许的收集时间，优先回收垃圾最多的区域。</p> <h4 id="gc常用参数"><a href="#gc常用参数" class="header-anchor">#</a> GC常用参数</h4> <p><img src="https://cdn.nlark.com/yuque/0/2022/png/12450544/1645712381283-5e0a110f-cb8b-4779-8eea-be9737980515.png" alt="img"></p> <h3 id="内存分配与回收策略"><a href="#内存分配与回收策略" class="header-anchor">#</a> 内存分配与回收策略</h3> <h4 id="对象优先在eden分配"><a href="#对象优先在eden分配" class="header-anchor">#</a> 对象优先在Eden分配</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 2022/2/26
 * 参数 -XX:+PrintGCDetails -Xms20M -Xmx20M -Xmn10M -XX:SurvivorRatio=8 -XX:+UseSerialGC
 * Eden:10M，其中9M可用
 * Serial+Serial Old组合
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestAllocation</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> _1MB <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a1<span class="token punctuation">,</span>a2<span class="token punctuation">,</span>a3<span class="token punctuation">,</span>a4<span class="token punctuation">,</span>a5<span class="token punctuation">;</span>
        a1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> _1MB<span class="token punctuation">]</span><span class="token punctuation">;</span>
        a2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> _1MB<span class="token punctuation">]</span><span class="token punctuation">;</span>
        a3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> _1MB<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// 出现一次Minor GC</span>
        a4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> _1MB<span class="token punctuation">]</span><span class="token punctuation">;</span>    
        a5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> _1MB<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里的GC日志与书中的日志不相符。</p> <p>书中描述，当分配a4的时候，由于共9M的eden空间不足，于是触发MinorGC，但是由于Survivor区只有1M，空间不足以放a1、a2、a3，于是通过分配担保机制，这6M大小进入老年代，4M的a4会分配在Elden</p> <p>但是实测下来，分配了5M之前都是在Eden区，但是a1、a2、a3共6M分配之后，就已经开始出现MinorGC。a1、a2共4M进入了老年代，a3分配到了eden</p> <div class="language-plain extra-class"><pre class="language-plain"><code>[GC (Allocation Failure) [DefNew: 6444K-&gt;810K(9216K), 0.0042813 secs] 6444K-&gt;4906K(19456K), 0.0043266 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
Heap
 def new generation   total 9216K, used 3188K [0x00000000fec00000, 0x00000000ff600000, 0x00000000ff600000)
  eden space 8192K,  29% used [0x00000000fec00000, 0x00000000fee52998, 0x00000000ff400000)
  from space 1024K,  79% used [0x00000000ff500000, 0x00000000ff5ca8f8, 0x00000000ff600000)
  to   space 1024K,   0% used [0x00000000ff400000, 0x00000000ff400000, 0x00000000ff500000)
 tenured generation   total 10240K, used 4096K [0x00000000ff600000, 0x0000000100000000, 0x0000000100000000)
   the space 10240K,  40% used [0x00000000ff600000, 0x00000000ffa00020, 0x00000000ffa00200, 0x0000000100000000)
 Metaspace       used 3303K, capacity 4496K, committed 4864K, reserved 1056768K
  class space    used 360K, capacity 388K, committed 512K, reserved 1048576K
</code></pre></div><p>分配完a4的日志如下：可以看出a3、a4共计6M分配在Eden区，老年代4M</p> <div class="language-plain extra-class"><pre class="language-plain"><code>[GC (Allocation Failure) [DefNew: 6444K-&gt;797K(9216K), 0.0033512 secs] 6444K-&gt;4893K(19456K), 0.0034188 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
Heap
 def new generation   total 9216K, used 7429K [0x00000000fec00000, 0x00000000ff600000, 0x00000000ff600000)
  eden space 8192K,  80% used [0x00000000fec00000, 0x00000000ff279e48, 0x00000000ff400000)
  from space 1024K,  77% used [0x00000000ff500000, 0x00000000ff5c76a8, 0x00000000ff600000)
  to   space 1024K,   0% used [0x00000000ff400000, 0x00000000ff400000, 0x00000000ff500000)
 tenured generation   total 10240K, used 4096K [0x00000000ff600000, 0x0000000100000000, 0x0000000100000000)
   the space 10240K,  40% used [0x00000000ff600000, 0x00000000ffa00020, 0x00000000ffa00200, 0x0000000100000000)
 Metaspace       used 3262K, capacity 4496K, committed 4864K, reserved 1056768K
  class space    used 359K, capacity 388K, committed 512K, reserved 1048576K
</code></pre></div><p>如果再分配1M的a5，仍然在Eden区，共7M，这里很奇怪，之前6M就已经触发MinorGC，这时没有触发，如果a5大小为2M，会触发第二次MinorGC，a3也会进入老年代，剩下a4、a5共6M在Eden</p> <div class="language-plain extra-class"><pre class="language-plain"><code>[GC (Allocation Failure) [DefNew: 6444K-&gt;800K(9216K), 0.0035625 secs] 6444K-&gt;4897K(19456K), 0.0036098 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
[GC (Allocation Failure) [DefNew (promotion failed) : 7350K-&gt;6570K(9216K), 0.0019683 secs][Tenured: 6845K-&gt;6845K(10240K), 0.0024806 secs] 11446K-&gt;10962K(19456K), [Metaspace: 3258K-&gt;3258K(1056768K)], 0.0045052 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
Heap
 def new generation   total 9216K, used 6466K [0x00000000fec00000, 0x00000000ff600000, 0x00000000ff600000)
  eden space 8192K,  78% used [0x00000000fec00000, 0x00000000ff250950, 0x00000000ff400000)
  from space 1024K,   0% used [0x00000000ff400000, 0x00000000ff400000, 0x00000000ff500000)
  to   space 1024K,   0% used [0x00000000ff500000, 0x00000000ff500000, 0x00000000ff600000)
 tenured generation   total 10240K, used 6845K [0x00000000ff600000, 0x0000000100000000, 0x0000000100000000)
   the space 10240K,  66% used [0x00000000ff600000, 0x00000000ffcaf558, 0x00000000ffcaf600, 0x0000000100000000)
 Metaspace       used 3265K, capacity 4496K, committed 4864K, reserved 1056768K
  class space    used 359K, capacity 388K, committed 512K, reserved 1048576K
</code></pre></div><ul><li><strong>MinorGC</strong>：新生代的GC，新生代对象朝生夕死，回收速度比较快</li> <li><strong>MajorGC/FullGC</strong>：老年代的GC，出现了MajorGC，一般伴随着MinorGC(不绝对，ParallelScavenge可以选择直接MajorGC)。MajorGC速度比MinorGC慢10倍以上</li></ul> <h4 id="大对象直接进入老年代"><a href="#大对象直接进入老年代" class="header-anchor">#</a> 大对象直接进入老年代</h4> <p>大对象就是需要大量连续内存空间的对象，比如上面的byte[]，我们应该尽量避免大对象，因为会容易导致内存中海油不少空间就提前触发GC来存放大对象</p> <p>-XX:PretenureSizeThreshold=10M</p> <ul><li><p>可以设置阈值，大于阈值的对象，会直接分配在老年代</p></li> <li><p>避免Eden区与Survivor区之间发生大量内存拷贝</p></li> <li><p>只对Serial、ParNew两款收集器有效</p></li></ul> <h4 id="长期存活的对象将进入老年代"><a href="#长期存活的对象将进入老年代" class="header-anchor">#</a> 长期存活的对象将进入老年代</h4> <p>出生在Eden区的对象，对象年龄为0，经过第一次MinorGC且能被Survivor容纳的话，对象年龄为1。然后每熬过一轮MinorGC，对象年龄+1，当达到阈值(默认15)，将进入老年代。阈值通过参数-XX:MaxTenuringThreshold设置</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 2022/2/27
 * 进入老年代的阈值-XX:MaxTenuringThreshold
 * -XX:+PrintGCDetails -Xms20M -Xmx20M -Xmn10M -XX:SurvivorRatio=8 -XX:+UseSerialGC -XX:MaxTenuringThreshold=1 -XX:+PrintTenuringDistribution
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestTenuringThreshold</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> _1MB <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a1<span class="token punctuation">,</span>a2<span class="token punctuation">,</span>a3<span class="token punctuation">;</span>
        a1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>_1MB <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        a2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> _1MB<span class="token punctuation">]</span><span class="token punctuation">;</span>
        a3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> _1MB<span class="token punctuation">]</span><span class="token punctuation">;</span>
        a3 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        a3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">*</span> _1MB<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>实测下来，现象与书中不一致，原因暂时没有想明白。</p> <p>MaxTenuringThreshold=1:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token punctuation">[</span>GC <span class="token punctuation">(</span><span class="token class-name">Allocation</span> <span class="token class-name">Failure</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token class-name">DefNew</span>
<span class="token class-name">Desired</span> survivor size <span class="token number">524288</span> bytes<span class="token punctuation">,</span> <span class="token keyword">new</span> threshold <span class="token number">1</span> <span class="token punctuation">(</span>max <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token operator">-</span> age   <span class="token number">1</span><span class="token operator">:</span>    <span class="token number">1048576</span> bytes<span class="token punctuation">,</span>    <span class="token number">1048576</span> total
<span class="token operator">:</span> <span class="token number">6700</span>K<span class="token operator">-&gt;</span><span class="token function">1024K</span><span class="token punctuation">(</span><span class="token number">9216</span>K<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0052175</span> secs<span class="token punctuation">]</span> <span class="token number">6700</span>K<span class="token operator">-&gt;</span><span class="token function">5173K</span><span class="token punctuation">(</span><span class="token number">19456</span>K<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0052856</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name">Times</span><span class="token operator">:</span> user<span class="token operator">=</span><span class="token number">0.00</span> sys<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">,</span> real<span class="token operator">=</span><span class="token number">0.01</span> secs<span class="token punctuation">]</span> 
<span class="token punctuation">[</span>GC <span class="token punctuation">(</span><span class="token class-name">Allocation</span> <span class="token class-name">Failure</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token class-name">DefNew</span>
<span class="token class-name">Desired</span> survivor size <span class="token number">524288</span> bytes<span class="token punctuation">,</span> <span class="token keyword">new</span> threshold <span class="token number">1</span> <span class="token punctuation">(</span>max <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token operator">-</span> age   <span class="token number">1</span><span class="token operator">:</span>       <span class="token number">1792</span> bytes<span class="token punctuation">,</span>       <span class="token number">1792</span> total
<span class="token operator">:</span> <span class="token number">5368</span>K<span class="token operator">-&gt;</span><span class="token function">1K</span><span class="token punctuation">(</span><span class="token number">9216</span>K<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0016983</span> secs<span class="token punctuation">]</span> <span class="token number">9517</span>K<span class="token operator">-&gt;</span><span class="token function">5109K</span><span class="token punctuation">(</span><span class="token number">19456</span>K<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0017603</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name">Times</span><span class="token operator">:</span> user<span class="token operator">=</span><span class="token number">0.00</span> sys<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">,</span> real<span class="token operator">=</span><span class="token number">0.00</span> secs<span class="token punctuation">]</span> 
<span class="token class-name">Heap</span>
 def <span class="token keyword">new</span> generation   total <span class="token number">9216</span>K<span class="token punctuation">,</span> used <span class="token number">4235</span>K <span class="token punctuation">[</span><span class="token number">0x00000000fec00000</span><span class="token punctuation">,</span> <span class="token number">0x00000000ff600000</span><span class="token punctuation">,</span> <span class="token number">0x00000000ff600000</span><span class="token punctuation">)</span>
  eden space <span class="token number">8192</span>K<span class="token punctuation">,</span>  <span class="token number">51</span><span class="token operator">%</span> used <span class="token punctuation">[</span><span class="token number">0x00000000fec00000</span><span class="token punctuation">,</span> <span class="token number">0x00000000ff022798</span><span class="token punctuation">,</span> <span class="token number">0x00000000ff400000</span><span class="token punctuation">)</span>
  from space <span class="token number">1024</span>K<span class="token punctuation">,</span>   <span class="token number">0</span><span class="token operator">%</span> used <span class="token punctuation">[</span><span class="token number">0x00000000ff400000</span><span class="token punctuation">,</span> <span class="token number">0x00000000ff400700</span><span class="token punctuation">,</span> <span class="token number">0x00000000ff500000</span><span class="token punctuation">)</span>
  <span class="token keyword">to</span>   <span class="token namespace">space</span> <span class="token number">1024</span>K<span class="token punctuation">,</span>   <span class="token number">0</span><span class="token operator">%</span> used <span class="token punctuation">[</span><span class="token number">0x00000000ff500000</span><span class="token punctuation">,</span> <span class="token number">0x00000000ff500000</span><span class="token punctuation">,</span> <span class="token number">0x00000000ff600000</span><span class="token punctuation">)</span>
 tenured generation   total <span class="token number">10240</span>K<span class="token punctuation">,</span> used <span class="token number">5107</span>K <span class="token punctuation">[</span><span class="token number">0x00000000ff600000</span><span class="token punctuation">,</span> <span class="token number">0x0000000100000000</span><span class="token punctuation">,</span> <span class="token number">0x0000000100000000</span><span class="token punctuation">)</span>
   the space <span class="token number">10240</span>K<span class="token punctuation">,</span>  <span class="token number">49</span><span class="token operator">%</span> used <span class="token punctuation">[</span><span class="token number">0x00000000ff600000</span><span class="token punctuation">,</span> <span class="token number">0x00000000ffafce90</span><span class="token punctuation">,</span> <span class="token number">0x00000000ffafd000</span><span class="token punctuation">,</span> <span class="token number">0x0000000100000000</span><span class="token punctuation">)</span>
 <span class="token class-name">Metaspace</span>       used <span class="token number">3324</span>K<span class="token punctuation">,</span> capacity <span class="token number">4496</span>K<span class="token punctuation">,</span> committed <span class="token number">4864</span>K<span class="token punctuation">,</span> reserved <span class="token number">1056768</span>K
  <span class="token keyword">class</span> space    used <span class="token number">361</span>K<span class="token punctuation">,</span> capacity <span class="token number">388</span>K<span class="token punctuation">,</span> committed <span class="token number">512</span>K<span class="token punctuation">,</span> reserved <span class="token number">1048576</span>K
</code></pre></div><p>书中描述：a1大小256k，分配a2的时候触发第一次MinorGC，Survivor足够容纳，进入Survivor，对象年龄为1。第二次MinorGC时，因为阈值为1，此时进入老年代。新生代会干净</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/png/12450544/1645959217253-e331ce0c-0ece-4d09-8c6b-e59742ac7f52.png" alt="img"></p> <p>MaxTenuringThreshold=15:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token punctuation">[</span>GC <span class="token punctuation">(</span><span class="token class-name">Allocation</span> <span class="token class-name">Failure</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token class-name">DefNew</span>
<span class="token class-name">Desired</span> survivor size <span class="token number">524288</span> bytes<span class="token punctuation">,</span> <span class="token keyword">new</span> threshold <span class="token number">1</span> <span class="token punctuation">(</span>max <span class="token number">15</span><span class="token punctuation">)</span>
<span class="token operator">-</span> age   <span class="token number">1</span><span class="token operator">:</span>    <span class="token number">1048576</span> bytes<span class="token punctuation">,</span>    <span class="token number">1048576</span> total
<span class="token operator">:</span> <span class="token number">6700</span>K<span class="token operator">-&gt;</span><span class="token function">1024K</span><span class="token punctuation">(</span><span class="token number">9216</span>K<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0029448</span> secs<span class="token punctuation">]</span> <span class="token number">6700</span>K<span class="token operator">-&gt;</span><span class="token function">5148K</span><span class="token punctuation">(</span><span class="token number">19456</span>K<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0029874</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name">Times</span><span class="token operator">:</span> user<span class="token operator">=</span><span class="token number">0.00</span> sys<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">,</span> real<span class="token operator">=</span><span class="token number">0.00</span> secs<span class="token punctuation">]</span> 
<span class="token punctuation">[</span>GC <span class="token punctuation">(</span><span class="token class-name">Allocation</span> <span class="token class-name">Failure</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token class-name">DefNew</span>
<span class="token class-name">Desired</span> survivor size <span class="token number">524288</span> bytes<span class="token punctuation">,</span> <span class="token keyword">new</span> threshold <span class="token number">15</span> <span class="token punctuation">(</span>max <span class="token number">15</span><span class="token punctuation">)</span>
<span class="token operator">-</span> age   <span class="token number">1</span><span class="token operator">:</span>       <span class="token number">1840</span> bytes<span class="token punctuation">,</span>       <span class="token number">1840</span> total
<span class="token operator">:</span> <span class="token number">5368</span>K<span class="token operator">-&gt;</span><span class="token function">1K</span><span class="token punctuation">(</span><span class="token number">9216</span>K<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0012153</span> secs<span class="token punctuation">]</span> <span class="token number">9492</span>K<span class="token operator">-&gt;</span><span class="token function">5078K</span><span class="token punctuation">(</span><span class="token number">19456</span>K<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0012501</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name">Times</span><span class="token operator">:</span> user<span class="token operator">=</span><span class="token number">0.00</span> sys<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">,</span> real<span class="token operator">=</span><span class="token number">0.00</span> secs<span class="token punctuation">]</span> 
<span class="token class-name">Heap</span>
 def <span class="token keyword">new</span> generation   total <span class="token number">9216</span>K<span class="token punctuation">,</span> used <span class="token number">4235</span>K <span class="token punctuation">[</span><span class="token number">0x00000000fec00000</span><span class="token punctuation">,</span> <span class="token number">0x00000000ff600000</span><span class="token punctuation">,</span> <span class="token number">0x00000000ff600000</span><span class="token punctuation">)</span>
  eden space <span class="token number">8192</span>K<span class="token punctuation">,</span>  <span class="token number">51</span><span class="token operator">%</span> used <span class="token punctuation">[</span><span class="token number">0x00000000fec00000</span><span class="token punctuation">,</span> <span class="token number">0x00000000ff022568</span><span class="token punctuation">,</span> <span class="token number">0x00000000ff400000</span><span class="token punctuation">)</span>
  from space <span class="token number">1024</span>K<span class="token punctuation">,</span>   <span class="token number">0</span><span class="token operator">%</span> used <span class="token punctuation">[</span><span class="token number">0x00000000ff400000</span><span class="token punctuation">,</span> <span class="token number">0x00000000ff400730</span><span class="token punctuation">,</span> <span class="token number">0x00000000ff500000</span><span class="token punctuation">)</span>
  <span class="token keyword">to</span>   <span class="token namespace">space</span> <span class="token number">1024</span>K<span class="token punctuation">,</span>   <span class="token number">0</span><span class="token operator">%</span> used <span class="token punctuation">[</span><span class="token number">0x00000000ff500000</span><span class="token punctuation">,</span> <span class="token number">0x00000000ff500000</span><span class="token punctuation">,</span> <span class="token number">0x00000000ff600000</span><span class="token punctuation">)</span>
 tenured generation   total <span class="token number">10240</span>K<span class="token punctuation">,</span> used <span class="token number">5076</span>K <span class="token punctuation">[</span><span class="token number">0x00000000ff600000</span><span class="token punctuation">,</span> <span class="token number">0x0000000100000000</span><span class="token punctuation">,</span> <span class="token number">0x0000000100000000</span><span class="token punctuation">)</span>
   the space <span class="token number">10240</span>K<span class="token punctuation">,</span>  <span class="token number">49</span><span class="token operator">%</span> used <span class="token punctuation">[</span><span class="token number">0x00000000ff600000</span><span class="token punctuation">,</span> <span class="token number">0x00000000ffaf52d0</span><span class="token punctuation">,</span> <span class="token number">0x00000000ffaf5400</span><span class="token punctuation">,</span> <span class="token number">0x0000000100000000</span><span class="token punctuation">)</span>
 <span class="token class-name">Metaspace</span>       used <span class="token number">3261</span>K<span class="token punctuation">,</span> capacity <span class="token number">4496</span>K<span class="token punctuation">,</span> committed <span class="token number">4864</span>K<span class="token punctuation">,</span> reserved <span class="token number">1056768</span>K
  <span class="token keyword">class</span> space    used <span class="token number">359</span>K<span class="token punctuation">,</span> capacity <span class="token number">388</span>K<span class="token punctuation">,</span> committed <span class="token number">512</span>K<span class="token punctuation">,</span> reserved <span class="token number">1048576</span>K
</code></pre></div><p>书中描述：当第二次MinorGC后，a1仍然留在Survivor，仍然有404k空间被占用。a1对象年龄为2</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/png/12450544/1645959203136-aeb3352d-4d47-4f02-8743-351a02656a80.png" alt="img"></p> <h4 id="空间分配担保"><a href="#空间分配担保" class="header-anchor">#</a> 空间分配担保</h4> <ul><li><p>MinorGC时，虚拟机检测之前每次晋升到老年代的对象平均大小，和老年代剩余空间比较，</p></li> <li><ul><li>如果大于，说明老年代很可能剩余空间不够这次晋升了，发生FullGC</li> <li>如果小于</li></ul></li> <li><ul><li><ul><li>-XX:-HandlerPromotionFailure，开关打开，只会进行MinorGC。</li> <li>开关关闭，FullGC</li></ul></li></ul></li> <li><p>这个开关打开的话，就是认为不怕担保失败，认为这次大概率小于平均值，可以担保成功。如果关闭的话，就是悲观地认为空间肯定不够，干脆直接FullGC</p></li> <li><p>如果本次对象大小突增，远高于平均值，那么就导致担保失败，失败之后会进行一次FullGC</p></li> <li><p>大部分情况下，会把开关打开，避免频繁FullGC</p></li></ul> <h2 id="_3-虚拟机性能监控与故障处理工具"><a href="#_3-虚拟机性能监控与故障处理工具" class="header-anchor">#</a> 3.虚拟机性能监控与故障处理工具</h2> <h3 id="命令行工具"><a href="#命令行工具" class="header-anchor">#</a> 命令行工具</h3> <h4 id="jps"><a href="#jps" class="header-anchor">#</a> jps</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">D</span><span class="token operator">:</span>\<span class="token class-name">Java</span>\<span class="token class-name">DemoCode</span>\JVM<span class="token operator">&gt;</span>jps
<span class="token number">543116</span> <span class="token class-name">Launcher</span>
<span class="token number">173156</span>
<span class="token number">250948</span> <span class="token class-name">TestDeadLock</span>
<span class="token number">260692</span> <span class="token class-name">Jps</span>
<span class="token number">476140</span> <span class="token class-name">Launcher</span>
</code></pre></div><p>可以列出正在运行的进程。由LVMID(Local Virtual Machine Identifier)、主类名称组成</p> <p>对于本地虚拟机进程：LVMID和操作系统的进程ID一致</p> <table><thead><tr><th>后缀</th> <th>功能</th></tr></thead> <tbody><tr><td>-q</td> <td>只输出LVMID</td></tr> <tr><td>-m</td> <td>输出传给main()函数的参数</td></tr> <tr><td>-l</td> <td>类的全名，如果执行的是Jar包，输出Jar包路径</td></tr> <tr><td>-v</td> <td>进程启动时JVM参数</td></tr></tbody></table> <h4 id="jstat"><a href="#jstat" class="header-anchor">#</a> jstat</h4> <ul><li><p>格式：jstat option vmid [interval[s|ms] [count]]</p></li> <li><ul><li>本地虚拟机vmid和lvmid一致， interval表示查询频率，默认ms，count表示查询次数</li> <li>如：jstat -gc 250948 250 20</li></ul></li></ul> <p><img src="https://cdn.nlark.com/yuque/0/2022/png/12450544/1645969460581-ee8613f1-7c89-4150-9ea4-4ce0d5a11b0a.png" alt="img"></p> <ul><li>-gcutil</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">D</span><span class="token operator">:</span>\<span class="token class-name">Java</span>\<span class="token class-name">DemoCode</span>\JVM<span class="token operator">&gt;</span>jstat <span class="token operator">-</span>gcutil <span class="token number">250948</span>
  S0     S1     <span class="token class-name">E</span>      <span class="token class-name">O</span>      <span class="token class-name">M</span>     CCS    YGC     YGCT    FGC    FGCT     GCT
  <span class="token number">0.00</span>  <span class="token number">33.73</span>  <span class="token number">43.81</span>   <span class="token number">0.01</span>  <span class="token number">94.27</span>  <span class="token number">88.95</span>      <span class="token number">1</span>    <span class="token number">0.005</span>     <span class="token number">0</span>    <span class="token number">0.000</span>    <span class="token number">0.005</span>
</code></pre></div><p>含义：</p> <table><thead><tr><th>S0</th> <th>S1</th> <th>E</th> <th>O</th> <th>M</th> <th>CCS</th> <th>YGC</th> <th>YGCT</th> <th>FGC</th> <th>FGCT</th> <th>GCT</th></tr></thead> <tbody><tr><td>Survivor</td> <td>Eden区</td> <td>永久代</td> <td></td> <td></td> <td>YoungGC次数</td> <td>YoungGC耗时</td> <td>FullGC次数</td> <td>FullGC耗时</td> <td>总GC耗时</td> <td></td></tr></tbody></table> <p>如果是P，表示永久代(Permanent)</p> <h4 id="jinfo"><a href="#jinfo" class="header-anchor">#</a> jinfo</h4> <p>jinfo [option] pid</p> <p>如：jinfo 250948</p> <h4 id="jmap"><a href="#jmap" class="header-anchor">#</a> jmap</h4> <p>可以获得堆转存储快照(heapdump/dump文件)</p> <ul><li><p>获得dump文件的方式：</p></li> <li><ul><li>kill -3，恐吓虚拟机</li> <li>-XX:+HeapDumpOnOutOfMemoryError，可以在OOM之后，自动生成dump文件</li></ul></li> <li><p>命令格式：jmap [option] vmid</p></li></ul> <p><img src="https://cdn.nlark.com/yuque/0/2022/png/12450544/1645971132036-6cb402b3-0c7b-4dd0-956d-a444b90db469.png" alt="img"></p> <h4 id="jhat"><a href="#jhat" class="header-anchor">#</a> jhat</h4> <p>dump文件的分析工具，一般不用，不会在服务器上直接分析dump文件，因为比较消耗硬件资源，而且功能也少</p> <p>一般用：Visual VM或者专业分析dump工具，如Eclipse Memory Analyzer、IBM HeapAnalyzer</p> <h4 id="jstack"><a href="#jstack" class="header-anchor">#</a> jstack</h4> <p>用于生成线程堆栈快照(threaddump文件或javacore文件)，目的是定位线程长时间停顿原因，如线程死锁、死循环、请求外部资源导致的长时间等待</p> <p>jstack [option]  vmid</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/png/12450544/1645971572877-a93a414e-0fd6-4024-8a16-059dc42f9926.png" alt="img"></p> <ul><li>实际项目中，可以通过下面的方法，输出堆栈信息，做成管理员页面</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token operator">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">,</span> <span class="token class-name">StackTraceElement</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> threadEntry <span class="token operator">:</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">getAllStackTraces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span> thread <span class="token operator">=</span> threadEntry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StackTraceElement</span><span class="token punctuation">[</span><span class="token punctuation">]</span> stackTrace <span class="token operator">=</span> threadEntry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>thread<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;\n线程:&quot;</span><span class="token operator">+</span> thread<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StackTraceElement</span> stackTraceElement <span class="token operator">:</span> stackTrace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;\t&quot;</span><span class="token operator">+</span> stackTraceElement<span class="token operator">+</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="可视化工具"><a href="#可视化工具" class="header-anchor">#</a> 可视化工具</h3> <h4 id="jconsole"><a href="#jconsole" class="header-anchor">#</a> Jconsole</h4> <p>1.内存监控</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 2022/3/6
 * -Xms100m -Xmx100m -XX:+UseSerialGC
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestMonitorMemory</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">OOMObject</span><span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> placeHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token function">fillHeap</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行完了方法&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fillHeap</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OOMObject</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">OOMObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>运行代码，指定堆内存100M。每次生成一个64K的对象，大概1600个对象会把堆填充满，然后发生OOM</p> <p>Eden区表现为折线图，一直在增加，满了就回收</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/png/12450544/1646532575383-ad2aca01-5885-4a1b-ae2e-fd2c292caf51.png" alt="img"></p> <p><img src="https://cdn.nlark.com/yuque/0/2022/png/12450544/1646534683871-0cf86836-d4bd-4676-ba77-82ad139b2056.png" alt="img"></p> <ul><li><p>上图中，堆内存表现为一直上涨，即时是循环了1000次，然后执行了System.gc()，被填充到堆中的对象还活着，直到最后发生OOM，才清空了堆内存。</p></li> <li><p>这是因为执行的时候，fillHeap方法仍然没有退出，list对象在执行的时候仍然处于作用域内。所以要把它放在fillHeap方法外执行</p></li> <li><p>如果执行2000次，会发生下面的结果，直到OOM，把堆内存清空</p></li></ul> <p><img src="https://cdn.nlark.com/yuque/0/2022/png/12450544/1646532951212-145e4232-f187-4172-aeef-572f51a057b9.png" alt="img"></p> <p>如下，把System.gc()放在方法外执行</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 2022/3/6
 * -Xms100m -Xmx100m -XX:+UseSerialGC
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestMonitorMemory</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">OOMObject</span><span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> placeHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token function">fillHeap</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行完了gc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fillHeap</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OOMObject</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">OOMObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>图片</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/png/12450544/1646533874647-1a4fcdcf-966e-4abd-9c68-814aa9cf7c4c.png" alt="img"></p> <h2 id="_4-调优案例分析与实战"><a href="#_4-调优案例分析与实战" class="header-anchor">#</a> 4.调优案例分析与实战</h2> <p><img src="https://cdn.nlark.com/yuque/0/2022/png/12450544/1646533874647-1a4fcdcf-966e-4abd-9c68-814aa9cf7c4c.png" alt="img"></p> <h2 id="_4-调优案例分析与实战-2"><a href="#_4-调优案例分析与实战-2" class="header-anchor">#</a> 4.调优案例分析与实战</h2></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/wu-Corey/wu-Corey.github.io/edit/master/docs/技术文章/00.Java/03.JVM/00.深入理解Java虚拟机读书笔记（一）.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/04/04, 11:35:06</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/e5bd2a/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">HashMap源码分析</div></a> <a href="/pages/d9969a/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">深入理解Java虚拟机读书笔记（二）</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/e5bd2a/" class="prev">HashMap源码分析</a></span> <span class="next"><a href="/pages/d9969a/">深入理解Java虚拟机读书笔记（二）</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/f47f51/"><div>BeanFactoryPostProcessor</div></a> <span>06-05</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/f6d9e1/"><div>深入理解Java虚拟机读书笔记（四）</div></a> <span>05-03</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/5cd412/"><div>深入理解Java虚拟机（三）</div></a> <span>04-30</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:1609495628@qq.com" title="邮箱" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/Wu-Corey" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="" title="音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2022
    <span>Corey | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.88395ae1.js" defer></script><script src="/assets/js/2.ea0e9185.js" defer></script><script src="/assets/js/3.674b93db.js" defer></script><script src="/assets/js/14.e4f36641.js" defer></script>
  </body>
</html>
